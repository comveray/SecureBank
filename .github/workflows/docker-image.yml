name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  security-semgrep:
    name: codebase scan
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    if: (github.actor != 'dependabot[bot]')
    steps:
      - uses: actions/checkout@v3
      - run: semgrep --config=auto .
      
  security-trufflehog:
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: secret scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

  publish: 
    needs: security-semgrep
    name: builds docker image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: build the docker image
        run: docker build . --file dockerimage/Dockerfile --tag my-image-name:$(date +%s)
